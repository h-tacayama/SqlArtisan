# SqlArtisan
⚠️ **Warning: Work In Progress (WIP) & Unstable** ⚠️

This project is currently under **active development**. It should be considered **unstable**, and breaking changes may occur without notice as the API evolves. **Use in production environments is strongly discouraged at this stage.**

[![Lifecycle](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://github.com/h-tacayama/SqlArtisan)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![DeepWiki](https://img.shields.io/badge/DeepWiki-h--tacayama%2FSqlArtisan-blue.svg?logo=data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAyCAYAAAAnWDnqAAAAAXNSR0IArs4c6QAAA05JREFUaEPtmUtyEzEQhtWTQyQLHNak2AB7ZnyXZMEjXMGeK/AIi+QuHrMnbChYY7MIh8g01fJoopFb0uhhEqqcbWTp06/uv1saEDv4O3n3dV60RfP947Mm9/SQc0ICFQgzfc4CYZoTPAswgSJCCUJUnAAoRHOAUOcATwbmVLWdGoH//PB8mnKqScAhsD0kYP3j/Yt5LPQe2KvcXmGvRHcDnpxfL2zOYJ1mFwrryWTz0advv1Ut4CJgf5uhDuDj5eUcAUoahrdY/56ebRWeraTjMt/00Sh3UDtjgHtQNHwcRGOC98BJEAEymycmYcWwOprTgcB6VZ5JK5TAJ+fXGLBm3FDAmn6oPPjR4rKCAoJCal2eAiQp2x0vxTPB3ALO2CRkwmDy5WohzBDwSEFKRwPbknEggCPB/imwrycgxX2NzoMCHhPkDwqYMr9tRcP5qNrMZHkVnOjRMWwLCcr8ohBVb1OMjxLwGCvjTikrsBOiA6fNyCrm8V1rP93iVPpwaE+gO0SsWmPiXB+jikdf6SizrT5qKasx5j8ABbHpFTx+vFXp9EnYQmLx02h1QTTrl6eDqxLnGjporxl3NL3agEvXdT0WmEost648sQOYAeJS9Q7bfUVoMGnjo4AZdUMQku50McDcMWcBPvr0SzbTAFDfvJqwLzgxwATnCgnp4wDl6Aa+Ax283gghmj+vj7feE2KBBRMW3FzOpLOADl0Isb5587h/U4gGvkt5v60Z1VLG8BhYjbzRwyQZemwAd6cCR5/XFWLYZRIMpX39AR0tjaGGiGzLVyhse5C9RKC6ai42ppWPKiBagOvaYk8lO7DajerabOZP46Lby5wKjw1HCRx7p9sVMOWGzb/vA1hwiWc6jm3MvQDTogQkiqIhJV0nBQBTU+3okKCFDy9WwferkHjtxib7t3xIUQtHxnIwtx4mpg26/HfwVNVDb4oI9RHmx5WGelRVlrtiw43zboCLaxv46AZeB3IlTkwouebTr1y2NjSpHz68WNFjHvupy3q8TFn3Hos2IAk4Ju5dCo8B3wP7VPr/FGaKiG+T+v+TQqIrOqMTL1VdWV1DdmcbO8KXBz6esmYWYKPwDL5b5FA1a0hwapHiom0r/cKaoqr+27/XcrS5UwSMbQAAAABJRU5ErkJggg==)](https://deepwiki.com/h-tacayama/SqlArtisan)
<!-- DeepWiki badge generated by https://deepwiki.ryoppippi.com/ -->

---

**SqlArtisan**: Write SQL, in C#. A SQL query builder that provides a SQL-like experience, designed for developers who value the clarity and control of direct SQL syntax.

## Key Features

- **SQL-like API**: Write queries naturally, mirroring SQL syntax and structure.
- **Schema IntelliSense**: Provides code completion for table/column names via definition classes, improving development speed and accuracy.
- **Automatic Parameterization**: Converts literals to bind variables, boosting security (SQLi prevention) and query performance.
- **Dynamic Query Building**: Dynamically include or exclude specific conditions, especially in WHERE clauses, based on application logic or user input.
- **Low-Allocation Design**: Minimizes heap allocations and GC load for superior performance.
- **Seamless Dapper Integration**: The optional `SqlArtisan.DapperExtensions` library provides Dapper extensions that enable effortless SQL execution.

## Getting Started

### Prerequisites

- .NET 8.0 or later.
- SqlArtisan is currently verified with PostgreSQL and Oracle.
- (Optional) To use the Dapper integration features (as shown in examples), install the `SqlArtisan.DapperExtensions` package.

### Installation

You can install SqlArtisan and its optional Dapper integration library via NuGet Package Manager.
*(Note: These packages are currently in their pre-release phase, so use the --prerelease flag when installing.)*

For the core query building functionality:

```bash
dotnet add package SqlArtisan --prerelease
```

For seamless execution with Dapper (recommended):

```bash
dotnet add package SqlArtisan.DapperExtensions --prerelease
```

### Quick Start

1. Define your Table Schema Class

    Create C# classes for your database tables to enable IntelliSense and prevent typos in names. You can write these manually (see example below) or generate them from an existing database with the `SqlArtisan.TableClassGen` tool.

    ```csharp
    using SqlArtisan;
    ```
    ```csharp
    internal sealed class UsersTable : DbTableBase
    {
        public UsersTable(string tableAlias) : base("users", tableAlias)
        {
            Id = new DbColumn(tableAlias, "id");
            Name = new DbColumn(tableAlias, "name");
            CreatedAt = new DbColumn(tableAlias, "created_at");
        }

        public DbColumn Id { get; }
        public DbColumn Name { get; }
        public DbColumn CreatedAt { get; }
    }
    ```

2. Define your DTO Class

    Create a Data Transfer Object (DTO) class. This class will be used to map the results of your SQL query.

    ```csharp
    internal sealed class UserDto(int id, string name, DateTime createdAt)
    {
        public int Id => id;
        public string Name => name;
        public DateTime CreatedAt => createdAt;
    }
    ```

3. Build and Execute your Query

    Use SqlArtisan's SQL-like API to construct your query, then execute it. This example uses Dapper with `SqlArtisan.DapperExtensions` for execution.

    ```csharp
    using SqlArtisan;
    using SqlArtisan.DapperExtensions;
    using static SqlArtisan.SqlWordbook;
    ```
    ```csharp
    UsersTable u = new("u");

    ISqlBuilder sql =
        Select(u.Id, u.Name, u.CreatedAt)
        .From(u)
        .Where(u.Id > 0 & u.Name.Like("G%"))
        .OrderBy(u.Id);

    // Dapper: Set true to map snake_case columns to PascalCase/camelCase C# members
    Dapper.DefaultTypeMap.MatchNamesWithUnderscores = true;
    IEnumerable<UserDto> users = await _conn.QueryAsync<UserDto>(sql);
    ```

    **Alternative: Manual Execution (Accessing SQL and Parameters)**

    While SqlArtisan.DapperExtensions provides convenience, you can also directly access the generated SQL string and parameters. This allows you to use SqlArtisan with raw ADO.NET, other micro-ORMs, or for debugging purposes.

    ```csharp
    UsersTable u = new("u");

    SqlStatement sql =
        Select(u.Id, u.Name, u.CreatedAt)
        .From(u)
        .Where(u.Id > 0 & u.Name.Like("G%"))
        .OrderBy(u.Id)
        .Build();

    string sqlText = sql.Text;
    // SELECT "u".id, "u".name, "u".created_at
    // FROM users "u"
    // WHERE ("u".id > :0) AND ("u".name LIKE :1)
    // ORDER BY "u".id

    int param1 = sql.Parameters.Get<int>(":0");
    // param1 = 0

    string? param2 = sql.Parameters.Get<string>(":1");
    // param2 = "G%"
    ```

## Performance

SqlArtisan is engineered for efficient performance, primarily by keeping heap memory allocations low.

Our core strategy is efficient buffer management using ArrayPool<T>. Internal buffers, particularly for string construction, are recycled from a shared pool, avoiding repeated heap allocations.

This approach leads to fewer garbage collection (GC) pauses, better application throughput as more CPU power is available for your core tasks, and efficient memory use because buffers are reused.

## License

This project is licensed under the MIT License. See the [LICENSE](LICENSE) file for the full license text.
